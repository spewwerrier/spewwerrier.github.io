<!doctype html>
<html lang="en">
    <head>
        <script defer>
            // this is in head to prevent flashbang
            const theme = localStorage.getItem("data-theme") ?? "burgerburn";
            document.documentElement.setAttribute("data-theme", theme);
        </script>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="/base.css" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" />
        <link rel="stylesheet" href="/normalize.css" />
    </head>

    <nav class="navbar bg-base-100">
        <div class="flex-1">
            <a class="btn btn-ghost text-xl" href="/">Aagaman Luitel</a>
        </div>
        <div class="flex-none">
            <div class="dropdown ml-10">
                <label tabindex="0" class="btn ml-10">Themes</label>
                <ul tabindex="0" class="menu dropdown-content shadow-sm">
                    <li>
                        <button class="btn" onclick="applyColor('lovelace')">
                            lovelace
                        </button>
                        <button class="btn" onclick="applyColor('corporate')">
                            corporate
                        </button>
                        <button class="btn" onclick="applyColor('blues')">
                            blues
                        </button>
                        <button class="btn" onclick="applyColor('whites')">
                            whites
                        </button>
                        <button class="btn" onclick="applyColor('burgerburn')">
                            burgerburn
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <body>
        <section class="section">

<head>
    <link rel="stylesheet" type="text/css" href="/single.css" />
    <title>Writing a load balancer in golang</title>
</head>
<h1 class="title">Writing a load balancer in golang</h1>

<p class="subtitle">
    <strong>2024-10-22 | 14mins </strong>
</p>

<!-- https://www.getzola.org/documentation/templates/pages-sections/#table-of-contents -->
<!--
<div class="toc">
    <details>
        <summary>Table Of Contents</summary>
        <ul>
            
            <li>
                <a href="https:&#x2F;&#x2F;luitelaagaman.com.np&#x2F;writings&#x2F;reverseproxy&#x2F;#reverse-proxy">Reverse proxy</a>
            </li>
            
            <li>
                <a href="https:&#x2F;&#x2F;luitelaagaman.com.np&#x2F;writings&#x2F;reverseproxy&#x2F;#accepting-https-connections">Accepting HTTPS connections</a>
            </li>
            
            <li>
                <a href="https:&#x2F;&#x2F;luitelaagaman.com.np&#x2F;writings&#x2F;reverseproxy&#x2F;#finalizing">Finalizing</a>
            </li>
            
        </ul>
    </details>
</div>

-->


<style>
    @media (max-width: 1200px) {
        .timeline {
            display: none;
        }
    }
</style>
<div class="article">
    <aside class="timeline-side" style="position: sticky; top: 2rem">
        <ul
            class="timeline timeline-vertical"
            style="position: fixed; right: 0; width: 500px"
        >
            
            <li>
                <hr />
                <div class="timeline-end timeline-box">
                    <a href="https:&#x2F;&#x2F;luitelaagaman.com.np&#x2F;writings&#x2F;reverseproxy&#x2F;#reverse-proxy">Reverse proxy</a>
                </div>
                <hr />
            </li>
            
            <li>
                <hr />
                <div class="timeline-end timeline-box">
                    <a href="https:&#x2F;&#x2F;luitelaagaman.com.np&#x2F;writings&#x2F;reverseproxy&#x2F;#accepting-https-connections">Accepting HTTPS connections</a>
                </div>
                <hr />
            </li>
            
            <li>
                <hr />
                <div class="timeline-end timeline-box">
                    <a href="https:&#x2F;&#x2F;luitelaagaman.com.np&#x2F;writings&#x2F;reverseproxy&#x2F;#finalizing">Finalizing</a>
                </div>
                <hr />
            </li>
            
        </ul>
    </aside>
    <article style="flex: 1"><h1 id="reverse-proxy">Reverse proxy</h1>
<p>From cloudfare: A reverse proxy is a server that sits in front of web servers and forwards client (e.g. web browser) requests to those web servers.<br />
So our objective is to create a server that feeds in the request, send the request to one of our server and send back the request. And to make it more interesting let us make our reverse proxy decide the efficient server. Our reverse proxy will sit on Layer 4 of OSI model (Transport layer) and choose server it wants. This is essentially a L4 load balancer.</p>
<h2 id="existing-load-balancer">Existing load balancer</h2>
<p>I tried https://github.com/yyyar/gobetween which is a L4 load balancer with a configuration
system. All you have to do is define your servers in gobetween.toml file and run the load balancer.
And your request to loadbalancer will be forwarded into servers. Now that we know what we want
lets simulate our load balancer</p>
<ul>
<li>
<p>Loadbalancer takes an request</p>
</li>
<li>
<p>Server1 is located on http://localhost:4444</p>
</li>
<li>
<p>Server2 is located on http://localhost:4445</p>
</li>
<li>
<p>Our load balancer (reverse proxy) is located on http://localhost:3000</p>
<ul>
<li>It has 2 servers configured at localhost:{4444,4445}</li>
</ul>
</li>
<li>
<p>request come to http://localhost:3000</p>
</li>
<li>
<p>forwards the request to Server1 or Server2</p>
</li>
<li>
<p>get the result</p>
</li>
</ul>
<h2 id="writing-our-own">Writing our own</h2>
<p>We will be using golang since it just works and thats what I'm most comfortable when it comes
to developing servers.</p>
<h3 id="server-endpoints">Server endpoints</h3>
<p>Lets define our server, instead of using configuration files and parsing them, I will be hardcoding
them into our source.</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-storage z-type z-keyword z-const z-go">const</span> <span class="z-punctuation z-section z-parens z-begin z-go">(</span>
</span><span class="z-source z-go">	<span class="z-variable z-other z-constant z-declaration z-go">SERVER1</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>localhost:4444<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go">	<span class="z-variable z-other z-constant z-declaration z-go">SERVER2</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>localhost:4445<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go">	<span class="z-variable z-other z-constant z-declaration z-go">SERVER3</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>localhost:4446<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go"><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></code></pre>
<h3 id="creating-dummy-servers">Creating dummy servers</h3>
<p>Make a separate folder and write the dummy servers. We will not be writing any super complicated servers but
they should work as well. I have tested this load balancer in some of my local http projects and it just works but for now
let us be simple. This server just prints which server it is, how many times it has been called and the headers
it is receiving.</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-keyword z-other z-package z-go">package</span> <span class="z-variable z-other z-go">main</span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-keyword z-other z-import z-go">import</span> <span class="z-punctuation z-section z-parens z-begin z-go">(</span>
</span><span class="z-source z-go">	<span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>fmt<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go">	<span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>net/http<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go"><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-var z-go">var</span> <span class="z-variable z-declaration z-go">v</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">int</span></span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">HomePage</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">w</span> <span class="z-variable z-other z-go">http</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">ResponseWriter</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">r</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">http</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Request</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">v</span><span class="z-keyword z-operator z-go">++</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Printf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>Server1 called <span class="z-constant z-other z-placeholder z-go">%d</span> times<span class="z-constant z-character z-escape z-go">\n</span><span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">v</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Println</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">w</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Header</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">r</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Header</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">w</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Write</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>hello world from server 1<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">main</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">http</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">HandleFunc</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>/<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">HomePage</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">http</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">ListenAndServe</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>localhost:4444<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-constant z-language z-go">nil</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre>
<p>Create 3-4 of these and put the address in SERVERS in our loadbalancer.</p>
<h2 id="the-load-balancer">The load balancer</h2>
<p>Golang has a powerful standard library which lets us use net, http, templates, crypto and many more
without external library. For now we will only be using net since it provides TCP/UDP network methods
which we need.</p>
<p>Our loadbalancer is still a server even if it makes request to another server.</p>
<p><code>Listen announces on the local network address. The network must be "tcp", "tcp4", "tcp6", "unix" or "unixpacket".</code>
Sounds like what we want. A server with tcp capabilities.</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">main</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">listener</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">net</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Listen</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>localhost:3000<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></code></pre>
<p>Note that localhost does not makes our server accessible from other machines, we need to use 0.0.0.0.
This applies everywhere. Use "localhost:3000" if you are communicating in your machine only or "0.0.0.0:3000" if
communicating through IPs. I will be using "localhost:3000" since I am not making request through another device/ip.<br />
And now we want to actually listen using the listener</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-keyword z-operator z-variadic z-go">...</span>
</span><span class="z-source z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span><span class="z-source z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span>
</span><span class="z-source z-go">
</span><span class="z-source z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">conn</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">listener</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Accept</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></code></pre>
<p><code>Accept waits for and returns the next connection to the listener</code>. It returns a new connection
from the incoming request. Lets do a simple ping test</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-keyword z-operator z-variadic z-go">...</span>
</span><span class="z-source z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span><span class="z-source z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span>
</span><span class="z-source z-go">
</span><span class="z-source z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-language z-blank z-go">_</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">listener</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Accept</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Println</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>conn<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre>
<p>Terminal (main)</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">owl@archlinux<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> $ go run main.go</span>
</span></code></pre>
<p>Terminal (curl)</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">owl@archlinux<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> $ curl localhost:3000</span>
</span></code></pre>
<p>Terminal (main)</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">owl@archlinux<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> $ go run main.go</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">conn</span></span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">conn</span></span>
</span></code></pre>
<p>Seems to be working.<br />
net also provides methods to connect to other servers with net.Dial</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-language z-blank z-go">_</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">listener</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Accept</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-language z-blank z-go">_</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">net</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">SERVER1</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre>
<p>Dial one of our server as soon as we get a request. This program
panics if SERVER1 is not active. Definitely a good thing. Now we read the incoming request and send to one of our servers.</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">conn</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">listener</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Accept</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> read from our l4 request
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">connDial</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">net</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">SERVER1</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> send the response to the server
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> read the response from the server
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> send the response to l4
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Printf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>sent<span class="z-constant z-character z-escape z-go">\n</span><span class="z-constant z-other z-placeholder z-go">%s</span><span class="z-constant z-character z-escape z-go">\n</span>to server: <span class="z-constant z-other z-placeholder z-go">%s</span><span class="z-constant z-character z-escape z-go">\n</span><span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">SERVER1</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre>
<p>Now replacing comments with code we get a reverse proxy in our hands. This works becase
http is essentially a TCP connection with http headers. When receiving http headers on our TCP server
we will just forward that http headers to the underlying servers. This is not the same for https servers where it
has a TLS/SSL layer on top which makes the header encrypted.</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go">
</span><span class="z-source z-go">	<span class="z-variable z-declaration z-go">sendBuf</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">make</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-constant z-numeric z-integer z-decimal z-go">1024</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span><span class="z-source z-go">	<span class="z-variable z-declaration z-go">recvBuf</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">make</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-constant z-numeric z-integer z-decimal z-go">1024</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span><span class="z-source z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">conn</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">listener</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Accept</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Read</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">sendBuf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">connDial</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">net</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">SERVER1</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">connDial</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Write</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">sendBuf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">connDial</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Read</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Write</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Printf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>sent<span class="z-constant z-character z-escape z-go">\n</span><span class="z-constant z-other z-placeholder z-go">%s</span><span class="z-constant z-character z-escape z-go">\n</span>to server: <span class="z-constant z-other z-placeholder z-go">%s</span><span class="z-constant z-character z-escape z-go">\n</span><span class="z-constant z-character z-escape z-go">\n</span>Received <span class="z-constant z-other z-placeholder z-go">%s</span><span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">sendBuf</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">SERVER1</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre>
<h2 id="the-actual-load-balancer">The actual load balancer</h2>
<p>Now that we know the basics of our reverse proxy, lets add a
load balancer algorithm and decide the server on runtime. This can be implemented however we like. I'll be focusing on 2 algorithms.
One is silly. Before lets make above code readable and reusable.</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">main</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">listener</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">net</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Listen</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>localhost:3000<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> buffer to store the fields we get from the incoming request
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">recvBuf</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">make</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-constant z-numeric z-integer z-decimal z-go">1024</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">conn</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">listener</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Accept</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Printf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>accepting a request...<span class="z-constant z-character z-escape z-go">\n</span><span class="z-constant z-character z-escape z-go">\n</span><span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Read</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">b</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go">dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">SERVER1</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Write</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">b</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> we dial one of our server with http fields stored in fields buffer
</span></span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">fields</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">address</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Printf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>dialing <span class="z-constant z-other z-placeholder z-go">%s</span><span class="z-constant z-character z-escape z-go">\n</span><span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">address</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">conn</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">net</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">address</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">defer</span> <span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Close</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">recvBuf</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">make</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-constant z-numeric z-integer z-decimal z-go">1024</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Write</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">fields</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-language z-blank z-go">_</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Read</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">recvBuf</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre>
<h3 id="round-robin-algorithm">Round Robin Algorithm</h3>
<p>Round robin algorithm distributes work evenly among all available resources.
In our case we will send request to SERVER1, SERVER2,... SERVER Nth, SERVER1, SERVER2.... and so on where nth is the
last server. This is not a full proof algorithm since in
real world there are better algorithms suited where the
load balancer has the workload stats of the server and
it chooses the most optimal one based on resource
availability. We use round robin because its one of the
algorithm used to create load balancer, and its simple.</p>
<p>Fortunately go makes this super easy. Lets create a struct called stateful servers since every server will have
a state where the state is number of time it is called</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-storage z-type z-keyword z-var z-go">var</span> <span class="z-variable z-declaration z-go">StatefulServers</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-storage z-type z-keyword z-map z-go">map</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">int</span></span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">SERVER1</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span><span class="z-punctuation z-separator z-go">,</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">SERVER2</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span><span class="z-punctuation z-separator z-go">,</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">SERVER3</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span><span class="z-punctuation z-separator z-go">,</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre>
<p>Now for round robin we want our dial function to call any SERVER. Any SERVER that gets returned, its state is increased by one. For this we will find out the SERVER
with least state. And return that server.</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">RoundRobin</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">fields</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> we need to get lowest value from our stateful servers
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">prev</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">StatefulServers</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-variable z-other z-go">SERVER1</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> find least state
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-variable z-language z-blank z-go">_</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">v</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-other z-go">range</span> <span class="z-variable z-other z-go">StatefulServers</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">v</span> <span class="z-keyword z-operator z-go">&lt;</span> <span class="z-variable z-other z-go">prev</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">prev</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">v</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-storage z-type z-keyword z-var z-go">var</span> <span class="z-variable z-declaration z-go">server</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-variable z-declaration z-go">k</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">v</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-other z-go">range</span> <span class="z-variable z-other z-go">StatefulServers</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">v</span> <span class="z-keyword z-operator z-go">==</span> <span class="z-variable z-other z-go">prev</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">server</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">k</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">StatefulServers</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-variable z-other z-go">server</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-keyword z-operator z-go">++</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-function z-go">dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">fields</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">server</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre>
<p>And thats it! Our load balancer is now complete.</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">main</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-keyword z-operator z-variadic z-go">...</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Printf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>accepting a request...<span class="z-constant z-character z-escape z-go">\n</span><span class="z-constant z-character z-escape z-go">\n</span><span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Read</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">b</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go">RoundRobin</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Write</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">b</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span>
</span></code></pre>
<h3 id="random-robin">Random Robin</h3>
<p>This is just choosing random servers but since I used
round robin earlier I will call this random robin. Kind
of silly but this is also the fun in programming.</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-storage z-type z-keyword z-var z-go">var</span> <span class="z-variable z-declaration z-go">servers</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">SERVER1</span><span class="z-punctuation z-separator z-go">,</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">SERVER2</span><span class="z-punctuation z-separator z-go">,</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">SERVER3</span><span class="z-punctuation z-separator z-go">,</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">RandomRobin</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">fields</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">i</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">rand</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Int</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-keyword z-operator z-go">%</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">len</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">servers</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-function z-go">dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">fields</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">servers</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-variable z-other z-go">i</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre>
<p>Use RandomRobin or RoundRobin the fact that our reverse proxy
chooses a server on its own makes it a load balancer that
just works.</p>
<h1 id="accepting-https-connections">Accepting HTTPS connections</h1>
<p>According to cloudfare: HTTPS is just the HTTP protocol but with data encryption using SSL/TLS.
So adding a tls config to our loadbalancer should make our http only to https supported.
Here is a great gist on how to create certificate and use tls in golang. And I followed the
same guide and will be referencing this as the guide.</p>
<ul>
<li>https://gist.github.com/denji/12b3a568f092ab951456</li>
</ul>
<h2 id="modifying-our-original-server-to-https">Modifying our original server to https</h2>
<p>After creating certificates</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-keyword z-operator z-variadic z-go">...</span>
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">main</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">http</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">HandleFunc</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>/<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">HomePage</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> err := http.ListenAndServe(&quot;localhost:4444&quot;, nil)
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">http</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">ListenAndServeTLS</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>:4446<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>server.crt<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>server.key<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-constant z-language z-go">nil</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-keyword z-operator z-variadic z-go">...</span>
</span></span></code></pre>
<h2 id="upgrade-loadbalancer-to-https-optional">Upgrade loadbalancer to https (optional)</h2>
<p>A load balancer can stay without tls and can make request to https connection. Its not
a requirement for communication but we will do here since why not. Again, make a new
certificate or use your old ones we used in our original server.
For tls config we should replace net with tls "crypto/package". LoadX509KeyPair parses a public and private key from a PEM encoded files (our openssl certificate).</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">main</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">cer</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">LoadX509KeyPair</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>server.crt<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>server.key<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">tlsConfig</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-operator z-go">&amp;</span><span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Config</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">Certificates</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Certificate</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span><span class="z-variable z-other z-go">cer</span><span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">listener</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Listen</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>localhost:3000<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">tlsConfig</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-operator z-variadic z-go">...</span>
</span></span></code></pre>
<p>This is server part, now our loadbalancer can be called through https://localhost:3000 but it still cannot
communicate to https servers.</p>
<h2 id="loadbalancer-to-support-https-request-response">Loadbalancer to support https request/response</h2>
<p>For our load balancer to make a tls request, the connection should include the tls certificate of the server. In our case we are
assuming every connection is https and have same tls config of server.crt. This cal also be seen in config file of gobetween.
<a href="https://github.com/yyyar/gobetween/blob/6e185295c8476810c64a27f5da28edd778e23423/config/gobetween.toml#L153">https://github.com/yyyar/gobetween/blob/6e185295c8476810c64a27f5da28edd778e23423/config/gobetween.toml#L153</a></p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-keyword z-operator z-variadic z-go">...</span>
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">fields</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">address</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">cert</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">os</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">ReadFile</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>server.crt<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">certPool</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">x509</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">NewCertPool</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">certPool</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">AppendCertsFromPEM</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">cert</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">conf</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-operator z-go">&amp;</span><span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Config</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">RootCAs</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-variable z-other z-go">certPool</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Printf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>dialing <span class="z-constant z-other z-placeholder z-go">%s</span><span class="z-constant z-character z-escape z-go">\n</span><span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">address</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">conn</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">address</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">conf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-keyword z-operator z-variadic z-go">...</span>
</span></span></code></pre>
<p>If we don't want to verify the tls of servers we can just ignore the
verification process, this way we don't have to remember tls
certificate of every server but we are essentially ignoring the
tls step. It should only be used for testing.</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-keyword z-operator z-variadic z-go">...</span>
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">fields</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">address</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">    <span class="z-variable z-declaration z-go">conf</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-operator z-go">&amp;</span><span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Config</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">      <span class="z-variable z-other z-go">InsecureSkipVerify</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-constant z-language z-go">true</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">    <span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">    <span class="z-variable z-declaration z-go">conn</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">address</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">conf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">    <span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-keyword z-operator z-variadic z-go">...</span>
</span></span></span></code></pre>
<h1 id="finalizing">Finalizing</h1>
<p>Now all that is left is to create a proper configuration system. I will be coding these
in the code itself, creating a struct for server like this</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-storage z-type z-keyword z-type z-go">type</span> <span class="z-entity z-name z-type z-go">Server</span> <span class="z-storage z-type z-keyword z-struct z-go">struct</span> <span class="z-meta z-type z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-type z-go">	<span class="z-variable z-other z-member z-declaration z-go">address</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-type z-go">	<span class="z-variable z-other z-member z-declaration z-go">tlspath</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-type z-go">	<span class="z-variable z-other z-member z-declaration z-go">https</span>   <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">bool</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-type z-go">	<span class="z-variable z-other z-member z-declaration z-go">state</span>   <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">int</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-type z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre>
<p>The other code is pretty much same with servers defined in main and changing data types of
our Round Robin algorithm. Here is the final code for our load balancer that support http as
well as https</p>
<pre data-lang="go" class="language-go z-code"><code class="language-go" data-lang="go"><span class="z-source z-go"><span class="z-keyword z-other z-package z-go">package</span> <span class="z-variable z-other z-go">main</span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-keyword z-other z-import z-go">import</span> <span class="z-punctuation z-section z-parens z-begin z-go">(</span>
</span><span class="z-source z-go">	<span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>crypto/tls<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go">	<span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>crypto/x509<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go">	<span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>fmt<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go">	<span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>net<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go">	<span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>os<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go"><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-type z-go">type</span> <span class="z-entity z-name z-type z-go">Server</span> <span class="z-storage z-type z-keyword z-struct z-go">struct</span> <span class="z-meta z-type z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-type z-go">	<span class="z-variable z-other z-member z-declaration z-go">address</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-type z-go">	<span class="z-variable z-other z-member z-declaration z-go">tlspath</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-type z-go">	<span class="z-variable z-other z-member z-declaration z-go">https</span>   <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">bool</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-type z-go">	<span class="z-variable z-other z-member z-declaration z-go">state</span>   <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">int</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-type z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-const z-go">const</span> <span class="z-punctuation z-section z-parens z-begin z-go">(</span>
</span><span class="z-source z-go">	<span class="z-variable z-other z-constant z-declaration z-go">SERVER1</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>localhost:4444<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go">	<span class="z-variable z-other z-constant z-declaration z-go">SERVER2</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>localhost:4445<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go">	<span class="z-variable z-other z-constant z-declaration z-go">SERVER3</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>localhost:4446<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span>
</span><span class="z-source z-go"><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">main</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">servers</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go">Server</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">address</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-variable z-other z-go">SERVER1</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">https</span><span class="z-punctuation z-separator z-go">:</span>   <span class="z-constant z-language z-go">true</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">state</span><span class="z-punctuation z-separator z-go">:</span>   <span class="z-constant z-numeric z-integer z-decimal z-go">1</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">address</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-variable z-other z-go">SERVER2</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">https</span><span class="z-punctuation z-separator z-go">:</span>   <span class="z-constant z-language z-go">false</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">state</span><span class="z-punctuation z-separator z-go">:</span>   <span class="z-constant z-numeric z-integer z-decimal z-go">1</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">address</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-variable z-other z-go">SERVER3</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">https</span><span class="z-punctuation z-separator z-go">:</span>   <span class="z-constant z-language z-go">true</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">state</span><span class="z-punctuation z-separator z-go">:</span>   <span class="z-constant z-numeric z-integer z-decimal z-go">1</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">cer</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">LoadX509KeyPair</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>server.crt<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>server.key<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">tlsConfig</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-operator z-go">&amp;</span><span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Config</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">Certificates</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Certificate</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span><span class="z-variable z-other z-go">cer</span><span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">listener</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Listen</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>localhost:3000<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">tlsConfig</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">recvBuf</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">make</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-constant z-numeric z-integer z-decimal z-go">1024</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">conn</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">listener</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Accept</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Printf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>accepting a request...<span class="z-constant z-character z-escape z-go">\n</span><span class="z-constant z-character z-escape z-go">\n</span><span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Read</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">b</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go">RoundRobin</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">servers</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Write</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">b</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">fields</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">address</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">istls</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">bool</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Printf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>dialing <span class="z-constant z-other z-placeholder z-go">%s</span><span class="z-constant z-character z-escape z-go">\n</span><span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">address</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">recvBuf</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">make</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-constant z-numeric z-integer z-decimal z-go">1024</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">istls</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">cert</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">os</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">ReadFile</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>server.crt<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">certPool</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">x509</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">NewCertPool</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">certPool</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">AppendCertsFromPEM</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">cert</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">conf</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-operator z-go">&amp;</span><span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Config</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">RootCAs</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-variable z-other z-go">certPool</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">conn</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">tls</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">address</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">conf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">defer</span> <span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Close</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Write</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">fields</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-language z-blank z-go">_</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Read</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span> <span class="z-keyword z-control z-go">else</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">conn</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">net</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">&quot;</span>tcp<span class="z-punctuation z-definition z-string z-end z-go">&quot;</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">address</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">defer</span> <span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Close</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Write</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">fields</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-language z-blank z-go">_</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">conn</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Read</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">recvBuf</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">panic</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">recvBuf</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">s</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">Server</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">IncrementState</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">s</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">state</span> <span class="z-keyword z-operator z-assignment z-go">+=</span> <span class="z-constant z-numeric z-integer z-decimal z-go">1</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">RoundRobin</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">fields</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">servers</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go">Server</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">byte</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">lowest</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">servers</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-constant z-numeric z-integer z-decimal z-go">0</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">state</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-variable z-language z-blank z-go">_</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">v</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-other z-go">range</span> <span class="z-variable z-other z-go">servers</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">v</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">state</span> <span class="z-keyword z-operator z-go">&lt;</span> <span class="z-variable z-other z-go">lowest</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">lowest</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">v</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">state</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-storage z-type z-keyword z-var z-go">var</span> <span class="z-variable z-declaration z-go">server</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">istls</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-constant z-language z-go">false</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-variable z-declaration z-go">i</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">v</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-other z-go">range</span> <span class="z-variable z-other z-go">servers</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">v</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">state</span> <span class="z-keyword z-operator z-go">==</span> <span class="z-variable z-other z-go">lowest</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">server</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">v</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">address</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">servers</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-variable z-other z-go">i</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">IncrementState</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">istls</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">servers</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-variable z-other z-go">i</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">https</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-keyword z-control z-go">break</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-function z-go">dial</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">fields</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">server</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">istls</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre>
</article>
</div>


<script src="/codeblock.js" defer="none"></script>

<footer>
     
</footer>

</section>
    </body>
    <script>
        // burgerburn, lovelace, corporate, whites, blues
        const applyColor = (themeName) => {
            localStorage.setItem("data-theme", themeName);
            document.documentElement.setAttribute("data-theme", themeName);
        };

        function pageDown() {
            window.scrollBy({
                top: window.innerHeight - 130,
                behavior: "smooth",
            });
        }

        function pageUp() {
            window.scrollBy({
                top: -(window.innerHeight - 130),
                behavior: "smooth",
            });
        }

        document.addEventListener("keydown", function (event) {
            if (event.key === "d" || event.key === "D") {
                pageDown();
            }
            if (event.key === "u") {
                pageUp();
            }
        });
    </script>
</html>
